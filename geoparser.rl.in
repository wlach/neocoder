#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "address.h"

%%{
    machine addrparser;
    action getStartStr {
    	   sp = p; 
    }
    action endNumber {
    	   std::string num_str;
	   num_str.assign(sp, (p-sp));
	   addr.number = atoi(num_str.c_str());
    }
    action endName {
    	   addr.street.assign(sp, (p-sp));
    }
    @SUFFIX_SUBEXPRESSIONS@

    streetNumber = (digit+ >getStartStr %endNumber);
    streetName = alpha+ >getStartStr %endName;
    suffix = @MAIN_SUFFIX_EXPRESSION@

    action endDirNorth { addr.direction = Address::NORTH; }
    action endDirNorthEast { addr.direction = Address::NORTHEAST; }
    action endDirEast { addr.direction = Address::EAST; }
    action endDirSouthEast { addr.direction = Address::SOUTHEAST; }
    action endDirSouth { addr.direction = Address::SOUTH; }
    action endDirSouthWest { addr.direction = Address::SOUTHWEST; }
    action endDirWest { addr.direction = Address::WEST; }
    action endDirNorthWest { addr.direction = Address::NORTHWEST; }

    directionNorth = ("n"i|"north"i) >getStartStr %endDirNorth;
    directionNorthEast = ("ne"i|"northeast"i|"north east"i) >getStartStr %endDirNorthEast;
    directionEast = ("e"i|"east"i) >getStartStr %endDirEast;
    directionSouthEast = ("se"i|"southeast"i|"south east"i) >getStartStr %endDirSouthEast;
    directionSouth = ("s"i|"south"i) >getStartStr %endDirSouth;
    directionSouthWest = ("sw"i|"southwest"i|"south west"i) >getStartStr %endDirSouthWest;
    directionWest = ("w"i|"west"i) >getStartStr %endDirWest;
    directionNorthWest = ("nw"i|"northwest"i|"north west"i) >getStartStr %endDirNorthWest;

    direction = (directionNorth|directionNorthEast|directionEast|directionSouthEast|directionSouthWest|directionWest|directionNorthWest);
    main := (streetNumber alpha? space+)? streetName (space+ suffix)? (space+ direction)? 0;
}%%

%% write data;

int main( int argc, char **argv )
{
    int cs, res = 0;
    if ( argc > 1 ) {
        Address addr;
	addr.number = 0;
	addr.suffix = Address::UNKNOWN_SUFFIX;
	addr.direction = Address::UNKNOWN_DIRECTION;
	char *sp = NULL;
	char *ep = NULL;

        char *p = argv[1];
        char *pe = p + strlen( p ) + 1;
	char *eof = NULL;
        %% write init;
        %% write exec;

	printf("address num %d street %s suffixId: %d dirId: %d\n", addr.number, addr.street.c_str(), addr.suffix, addr.direction);
    }
    printf("result = %d\n", res );
    return 0;
}
